#!/bin/bash

# Pre-push hook for OSM-Notes-Analytics
# Runs full test suite before allowing push
#
# To install: ln -sf ../../.git-hooks/pre-push .git/hooks/pre-push

set -e

echo "üöÄ Running pre-push validation..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "tests/run_quality_tests.sh" ]; then
    echo -e "${RED}‚ùå Not in project root directory${NC}"
    exit 1
fi

# Run quality tests
echo -e "${BLUE}üîç Running quality tests...${NC}"
if ./tests/run_quality_tests.sh > /tmp/pre-push-quality.log 2>&1; then
    echo -e "${GREEN}‚úÖ Quality tests passed${NC}"
else
    echo -e "${RED}‚ùå Quality tests failed${NC}"
    echo "   See /tmp/pre-push-quality.log for details"
    cat /tmp/pre-push-quality.log
    exit 1
fi

echo ""

# Optionally run DWH tests if database is available
if psql -d dwh -c "SELECT 1;" > /dev/null 2>&1; then
    echo -e "${BLUE}üîç Running DWH tests...${NC}"
    if timeout 300 ./tests/run_dwh_tests.sh > /tmp/pre-push-dwh.log 2>&1; then
        echo -e "${GREEN}‚úÖ DWH tests passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  DWH tests failed or timed out${NC}"
        echo "   You can still push, but please check the tests"
        echo "   See /tmp/pre-push-dwh.log for details"
        
        # Ask user if they want to continue
        read -p "Continue with push? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
else
    echo -e "${YELLOW}‚ÑπÔ∏è  Database 'dwh' not available, skipping DWH tests${NC}"
    echo "   Quality tests passed - allowing push"
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-push validation complete!${NC}"
echo ""

exit 0

