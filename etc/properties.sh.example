#!/bin/bash

# Set of properties for all scripts - EXAMPLE FILE
# Copy this file to properties.sh for your local configuration:
#   cp etc/properties.sh.example etc/properties.sh
# Then edit etc/properties.sh with your database credentials.
#
# Author: Andres Gomez
# Version: 2025-08-18

# Database configuration.
#
# IMPORTANT: This project uses separate databases for Ingestion and Analytics
# - DBNAME_INGESTION: Source database (Ingestion project - where notes are stored)
# - DBNAME_DWH: Analytics database (this project - where star schema DWH is stored)
#
# Separate database configuration for Ingestion and Analytics
# shellcheck disable=SC2034
if [[ -z "${DBNAME_INGESTION:-}" ]]; then
 declare -r DBNAME_INGESTION="${DBNAME_INGESTION:-notes}"
fi
# shellcheck disable=SC2034
if [[ -z "${DBNAME_DWH:-}" ]]; then
 declare -r DBNAME_DWH="${DBNAME_DWH:-notes_dwh}"
fi
# Database users for separate databases
# DB_USER_INGESTION: User for connecting to Ingestion database
# DB_USER_DWH: User for connecting to Analytics/DWH database
# Note: DB_USER is NOT used in this project (it's only valid in OSM-Notes-Ingestion project)
# shellcheck disable=SC2034
if [[ -z "${DB_USER_INGESTION:-}" ]]; then
 declare -r DB_USER_INGESTION="${DB_USER_INGESTION:-notes}"
fi
# shellcheck disable=SC2034
if [[ -z "${DB_USER_DWH:-}" ]]; then
 declare -r DB_USER_DWH="${DB_USER_DWH:-notes}"
fi

# Foreign Data Wrapper configuration (for accessing Ingestion DB from Analytics DB)
# Only needed when DBNAME_INGESTION != DBNAME_DWH
# shellcheck disable=SC2034
if [[ -z "${FDW_INGESTION_HOST:-}" ]]; then
 declare -r FDW_INGESTION_HOST="${FDW_INGESTION_HOST:-localhost}"
fi
# shellcheck disable=SC2034
if [[ -z "${FDW_INGESTION_DBNAME:-}" ]]; then
 declare -r FDW_INGESTION_DBNAME="${FDW_INGESTION_DBNAME:-${DBNAME_INGESTION}}"
fi
# shellcheck disable=SC2034
if [[ -z "${FDW_INGESTION_PORT:-}" ]]; then
 declare -r FDW_INGESTION_PORT="${FDW_INGESTION_PORT:-5432}"
fi
# shellcheck disable=SC2034
if [[ -z "${FDW_INGESTION_USER:-}" ]]; then
 # Default to same user as ingestion database (can be overridden for separate FDW user)
 declare -r FDW_INGESTION_USER="${FDW_INGESTION_USER:-${DB_USER_INGESTION:-notes}}"
fi
# shellcheck disable=SC2034
if [[ -z "${FDW_INGESTION_PASSWORD:-}" ]]; then
 # Default to empty (will use .pgpass file or peer authentication if available)
 # Set this if you need a specific password for FDW connections
 declare -r FDW_INGESTION_PASSWORD="${FDW_INGESTION_PASSWORD:-}"
fi

# Email configuration for reports.
declare EMAILS="${EMAILS:-notes@osm.lat}"

# OpenStreetMap API configuration.
# shellcheck disable=SC2034
declare OSM_API="${OSM_API:-https://api.openstreetmap.org/api/0.6}"

# OpenStreetMap Planet dump URL.
# shellcheck disable=SC2034
if [[ -z "${PLANET:-}" ]]; then
 declare -r PLANET="https://planet.openstreetmap.org"
fi

# Overpass interpreter URL. Used to download the countries and maritime boundaries.
# shellcheck disable=SC2034
if [[ -z "${OVERPASS_INTERPRETER:-}" ]]; then
 declare -r OVERPASS_INTERPRETER="https://overpass-api.de/api/interpreter"
fi

# Rate limiting configuration.
# Wait between loops when downloading boundaries, to prevent "Too many requests".
# shellcheck disable=SC2034
if [[ -z "${SECONDS_TO_WAIT:-}" ]]; then
 declare -r SECONDS_TO_WAIT="30"
fi

# Processing configuration.
# Quantity of notes to process per loop, to get the location of the note.
# shellcheck disable=SC2034
if [[ -z "${LOOP_SIZE:-}" ]]; then
 declare -r LOOP_SIZE="10000"
fi

# Maximum number of notes to download from the API.
# shellcheck disable=SC2034
if [[ -z "${MAX_NOTES:-}" ]]; then
 declare -r MAX_NOTES="10000"
fi

# Parallel processing configuration.
# Number of threads to use in parallel processing.
# It should be less than the number of cores of the server.
# shellcheck disable=SC2034
declare MAX_THREADS="4"

# Delay between launching parallel processes to prevent system overload.
# This helps stagger process creation and reduces memory pressure spikes.
# shellcheck disable=SC2034
if [[ -z "${PARALLEL_PROCESS_DELAY:-}" ]]; then
 declare -r PARALLEL_PROCESS_DELAY="2"
fi

# XSLT performance profiling configuration.
# Enable profiling to analyze and optimize XSLT transformations.
# Profile files are saved with .profile extension for analysis.
# shellcheck disable=SC2034
if [[ -z "${ENABLE_XSLT_PROFILING:-}" ]]; then
 declare -r ENABLE_XSLT_PROFILING="${ENABLE_XSLT_PROFILING:-false}"
fi

# XSLT processing maximum recursion depth
# Used for complex notes with long HTML/text to avoid recursion limit errors
# shellcheck disable=SC2034
if [[ -z "${XSLT_MAX_DEPTH:-}" ]]; then
 declare -r XSLT_MAX_DEPTH="4000"
fi

# Minimum number of notes to enable parallel processing.
# If the number of notes is less than this threshold, processing will be sequential.
# This helps avoid the overhead of parallelization for small datasets.
# shellcheck disable=SC2034
if [[ -z "${MIN_NOTES_FOR_PARALLEL:-}" ]]; then
 declare -r MIN_NOTES_FOR_PARALLEL="10"
fi

# Set MAX_THREADS based on available cores, with limits
if command -v nproc > /dev/null 2>&1; then
 MAX_THREADS=$(nproc)
 # Limit to reasonable values for production
 if [[ "${MAX_THREADS}" -gt 16 ]]; then
  MAX_THREADS=16
 fi
else
 MAX_THREADS=4
fi

# Cleanup configuration
# Controls whether temporary files and directories should be cleaned up after processing
# Set to false to preserve files for debugging purposes
declare CLEAN="${CLEAN:-true}"

# JSON Export configuration
# Output directory for datamart JSON exports (for web viewer)
# shellcheck disable=SC2034
if [[ -z "${JSON_OUTPUT_DIR:-}" ]]; then
 declare -r JSON_OUTPUT_DIR="${JSON_OUTPUT_DIR:-./output/json}"
fi

# PostgreSQL timeouts for ETL queries
# These timeouts help prevent long-running queries from blocking other operations
# statement_timeout: Maximum time a single statement can run (default: 30 minutes)
# lock_timeout: Maximum time to wait for a lock (default: 10 seconds)
# idle_in_transaction_session_timeout: Maximum time a transaction can be idle (default: 10 minutes)
# shellcheck disable=SC2034
if [[ -z "${PSQL_STATEMENT_TIMEOUT:-}" ]]; then
 declare -r PSQL_STATEMENT_TIMEOUT="${PSQL_STATEMENT_TIMEOUT:-30min}"
fi
# shellcheck disable=SC2034
if [[ -z "${PSQL_LOCK_TIMEOUT:-}" ]]; then
 declare -r PSQL_LOCK_TIMEOUT="${PSQL_LOCK_TIMEOUT:-10s}"
fi
# shellcheck disable=SC2034
if [[ -z "${PSQL_IDLE_IN_TRANSACTION_TIMEOUT:-}" ]]; then
 declare -r PSQL_IDLE_IN_TRANSACTION_TIMEOUT="${PSQL_IDLE_IN_TRANSACTION_TIMEOUT:-10min}"
fi

# Use READ ONLY transactions for queries that only read from ingestion tables
# This helps reduce lock contention and improves concurrency
# shellcheck disable=SC2034
if [[ -z "${PSQL_READONLY_FOR_INGESTION:-}" ]]; then
 declare -r PSQL_READONLY_FOR_INGESTION="${PSQL_READONLY_FOR_INGESTION:-true}"
fi
